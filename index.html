<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mobile Theremin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Helvetica', sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      overflow: hidden;
      user-select: none;
    }

    #modeSwitch {
      margin-top: 10px;
      width: 90%;
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    .modeBtn {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      background: #999;
      color: white;
    }

    .modeBtn.active {
      background: #333;
    }

    #display {
      text-align: center;
      font-size: 24px;
      margin: 20px 0 100px 0;
    }

    #frequency, #volume {
      margin: 10px 0;
    }

    #controls {
      position: fixed;
      bottom: 20px;
      width: 100%;
      padding: 0 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #powerBtn {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #ff5757;
      color: white;
      border: none;
      font-size: 18px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    #waveButtons {
      display: flex;
      width: 100%;
      justify-content: space-between;
      gap: 5px;
    }

    .waveBtn {
      flex: 1;
      height: 50px;
      background: #4a90e2;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <div id="modeSwitch">
    <button class="modeBtn active" data-mode="tilt">Tilt Mode</button>
    <button class="modeBtn" data-mode="position">Position Mode</button>
  </div>

  <div id="display">
    <div id="frequency">Frequency: — Hz</div>
    <div id="volume">Volume: — %</div>
  </div>

  <div id="controls">
    <button id="powerBtn">Start</button>
    <div id="waveButtons" style="display: none;">
      <button class="waveBtn" data-wave="sine">Sine</button>
      <button class="waveBtn" data-wave="sawtooth">Saw</button>
      <button class="waveBtn" data-wave="square">Square</button>
      <button class="waveBtn" data-wave="triangle">Triangle</button>
    </div>
  </div>

  <script>
    let audioCtx, oscillator, gainNode;
    let isPlaying = false;
    let currentWave = 'sine';
    let mode = 'tilt'; // or 'position'

    const powerBtn = document.getElementById('powerBtn');
    const waveButtons = document.getElementById('waveButtons');
    const freqDisplay = document.getElementById('frequency');
    const volDisplay = document.getElementById('volume');
    const modeButtons = document.querySelectorAll('.modeBtn');

    modeButtons.forEach(btn => {
      btn.onclick = () => {
        if (btn.classList.contains('active')) return;
        stopTheremin();
        modeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        mode = btn.getAttribute('data-mode');
      };
    });

    powerBtn.onclick = () => {
      if (!isPlaying) startTheremin();
      else stopTheremin();
    };

    document.querySelectorAll('.waveBtn').forEach(btn => {
      btn.onclick = () => {
        currentWave = btn.getAttribute('data-wave');
        if (oscillator) oscillator.type = currentWave;
      };
    });

    function startTheremin() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      oscillator = audioCtx.createOscillator();
      gainNode = audioCtx.createGain();

      oscillator.type = currentWave;
      oscillator.frequency.value = 440;
      gainNode.gain.value = 0.5;

      oscillator.connect(gainNode).connect(audioCtx.destination);
      oscillator.start();

      isPlaying = true;
      powerBtn.textContent = 'Stop';
      powerBtn.style.background = '#4caf50';
      waveButtons.style.display = 'flex';

      window.addEventListener('deviceorientation', handleOrientation);
      window.addEventListener('devicemotion', handleMotion);
    }

    function stopTheremin() {
      if (oscillator) {
        oscillator.stop();
        oscillator.disconnect();
        gainNode.disconnect();
      }
      oscillator = null;
      gainNode = null;
      isPlaying = false;
      powerBtn.textContent = 'Start';
      powerBtn.style.background = '#ff5757';
      waveButtons.style.display = 'none';
      freqDisplay.textContent = 'Frequency: — Hz';
      volDisplay.textContent = 'Volume: — %';
      window.removeEventListener('deviceorientation', handleOrientation);
      window.removeEventListener('devicemotion', handleMotion);
    }

    function handleOrientation(event) {
      if (!oscillator || !gainNode || mode !== 'tilt') return;

      const beta = event.beta || 0;   // forward/back
      const gamma = event.gamma || 0; // left/right

      let freq = 440 + beta * 10;
      freq = Math.max(100, Math.min(1200, freq));

      let volume = 0.5 + (gamma / 180);
      volume = Math.max(0, Math.min(1, volume));

      oscillator.frequency.value = freq;
      gainNode.gain.value = volume;

      freqDisplay.textContent = `Frequency: ${freq.toFixed(1)} Hz`;
      volDisplay.textContent = `Volume: ${(volume * 100).toFixed(0)} %`;
    }

    function handleMotion(event) {
      if (!oscillator || !gainNode || mode !== 'position') return;

      const accZ = event.accelerationIncludingGravity.z || 0;
      const accX = event.accelerationIncludingGravity.x || 0;

      // Use Z as vertical component approximation
      let freq = 440 + (accZ * -80); // invert so "up" = higher
      freq = Math.max(100, Math.min(1200, freq));

      let volume = 0.5 + (accX / 20);
      volume = Math.max(0, Math.min(1, volume));

      oscillator.frequency.value = freq;
      gainNode.gain.value = volume;

      freqDisplay.textContent = `Frequency: ${freq.toFixed(1)} Hz`;
      volDisplay.textContent = `Volume: ${(volume * 100).toFixed(0)} %`;
    }
  </script>
</body>
</html>
